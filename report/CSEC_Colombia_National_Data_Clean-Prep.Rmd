---
title: "CSEC in Colombia: National Stratum- Data Prep & Cleaning"
author: "Isaac Cormier"
date: "2025/08/05"
output:
  html_document:
    self_contained: true
    code_download: yes
    code_folding: hide
    theme:
      bslib: yes
    toc: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '5'
---

```{css, echo = FALSE}
table caption {
  caption-side: top !important;
}
```

```{r setup, include=FALSE}
library(fs)
#knitr::opts_knit$set(root.dir = fs::path_dir(knitr::current_input()))

options(repos = c(CRAN = "https://cloud.r-project.org"))
knitr::opts_chunk$set(echo = TRUE)

packages <- c("survey", "haven", "dplyr", "labelled", "tidyr", "DT", "skimr", "ggplot2", "knitr", "kableExtra", "svyweight", "purrr", "srvyr", "tibble", "here", "naniar")

if(!require("pacman"))install.packages("pacman")

pacman::p_load(char = packages, character.only = TRUE)
```

Below is the code and output for the data cleaning and preparation of the national 2018 Colombia VACS sample prior to data analysis. I've annotated the steps I've taken for convenience. Code sections are set to 'hide' by default; to see the code that was used to generate each section, select the 'show' button on the right hand side. Please note that much of the commands are wrapped in functions and workflows for rendering the data for RMarkdown. I've relied heavily on the `dplyr` package for cleaning the dataset.


# **1. Load Data**

Import the SPSS VACS data set and prepare a cleaned data frame for analysis. This includes re-coding variables into binary or factor formats, creating summary variables, and ensuring everything is labeled. For categorical variables with scaled levels (e.g., `MomClose`, `DadClose`), continuous, reverse-coded versions were added for use when computing the summary variables.

A codebook of the selected variables and re-coding procedure is saved under '/codebooks/CSEC_Colombia_codebook.xlsx'.

```{r loadData}
VACSData <- read_sav(here::here("rawdata", "Colombia_VACS_national_data.sav"))
```
# **2. Check Missing Values **
Check the raw dataset for missing values by preparing a missing value graph to see if there are any patterns in which values are missing. If several variables all seem to have missing values for the same cases, that suggests an intentional missing value (e.g., skipping a set of questions based on a previous answer).


```{r missingVars}
rawDF <- VACSData %>%
  select(
    DEPT, MUNI, PSU, USM, HH, VACS_ID, Wght_final, H6, H7H, H18, H19, H19A, H54, H56, H58,
    H20, Sex, Q2, Q2A, Q3, Q13, Q19, Q29, Q58, Q70, Q71, Q306, Q21, Q31, Q7, Q36E,
    Q59, Q80, Q82, Q84, Q86,
    Q407, Q409, Q500, Q600,
    Q700A, Q700B, Q800A, Q800B,
    Q1205, Q1207, Q1208, Q1209, Q1210, Q1200,
    Q100A, Q100B, Q100C, Q100D,
    Q116A, Q116B, Q116C, Q116D,
    Q128A, Q128B, Q128C, Q128D,
    Q142A, Q142B, Q142C, Q142D,
    Q300A, Q300B, Q300C, Q300D,
    Q305A, Q305B, Q305C, Q305D, Q305E, Q305F,
    Q1206A, Q1206B, Q1206C, Q1206D, Q1206E, Q1206F,
    Q400B, Q417, Q503
  )

#ggsave(
#  filename = "missing_data_plot.png",
#  plot = miss_plot,
#  width = 44,        # increase if needed (in inches)
#  height = 8,        # height in inches
#  dpi = 500          # high resolution
#)

```

```{r missinVarTable, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=100, fig.height=40}
cat('<div style="
  width: 100%;
  height: 600px; 
  overflow-x: scroll;
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')
book_colors <- c(
  "#E69F00",  # orange
  "#56B4E9",  # light blue
  "#009E73",  # green
  "#F0E442",  # yellow
  "#0072B2",  # dark blue
  "#D55E00",  # red
  "#CC79A7"   # pink
)

miss_plot <- rawDF %>% 
  vis_miss(cluster = TRUE, show_perc = TRUE, show_perc_col = TRUE) +
  scale_fill_manual(
    values = book_colors[c(3, 1)],
    labels = c("Present", "Missing"),
    name = ""
  ) +
  theme(
    plot.margin = margin(5.5, 30, 5.5, 5.5, "pt"),
    axis.text.x = element_text(angle = 70, hjust = 1, vjust = 1, size = 8),
    axis.text.y = element_text(size = 10),
    panel.grid.major.x = element_line(color = "black", size = 0.5),  # White lines between columns
    panel.grid.minor.x = element_blank(),
    text = element_text(size = 10),
    plot.title = element_text(size = 12),
        # Force the plot to use more space
    panel.spacing = unit(0.1, "cm"),
    strip.text = element_text(size = 9)
  )

# Save plot as temporary file with exact dimensions
temp_file <- tempfile(fileext = ".png")
ggsave(
  filename = temp_file,
  plot = miss_plot,
  width = 20,
  height = 6,
  dpi = 100
)

# Embed as HTML img tag with fixed width
cat(paste0('<img src="', temp_file, '" style="display: block; max-width: none; width: 2000px;">'))

cat('</div>')

```

Based on the graph above, there are a few variables that seem to be missing values across the same respondents, while a few others have a less distinctive pattern of missing values.

Below is a table of all variables that have a completion rate of less than 75%


```{r missing-data-analysis}
# Calculate missing values and completion rates for all variables
missing_summary <- rawDF %>%
  summarise_all(~sum(is.na(.))) %>%
  pivot_longer(everything(), names_to = "Variable_Name", values_to = "n_Missing") %>%
  mutate(
    Total_Observations = nrow(rawDF),
    Completion_Rate = round(((Total_Observations - n_Missing) / Total_Observations) * 100, 2)
  )

# Create mapping for cleaned variable names
cleaned_var_mapping <- c(
  "H54" = "ParentAbs",
  "H56" = "ChildOutHome", 
  "H58" = "ChildStreet",
  "Q409" = "FirstSexWanted",
  "Q500" = "SexTransact",
  "Q1209" = "SuicideAttempt",
  "Q305A" = "IPVEmot1",
  "Q305B" = "IPVEmot2",
  "Q305C" = "IPVEmot3",
  "Q305D" = "IPVEmot4",
  "Q305E" = "IPVEmot5",
  "Q305F" = "IPVEmot6",
  "Q400B" = "PhysCorp",
  "Q417" = "SexPartners"
)

# Filter for variables with completion rate < 75%
low_completion <- missing_summary %>%
  filter(Completion_Rate < 75) %>%
  mutate(
    Cleaned_Var_Name = ifelse(Variable_Name %in% names(cleaned_var_mapping), 
                              cleaned_var_mapping[Variable_Name], 
                              Variable_Name)
  ) %>%
  select(`Variable Name` = Variable_Name,
         `Cleaned Var Name` = Cleaned_Var_Name,
         `n Missing` = n_Missing, 
         `Total Observations` = Total_Observations,
         `Completion Rate (%)` = Completion_Rate)

# Display the table
if(nrow(low_completion) > 0) {
  knitr::kable(low_completion, 
               caption = "Variables with Completion Rate < 75%",
               align = c("l", "l", "c", "c", "c"))
} else {
  cat("No variables have completion rates below 75%")
}
```

To look at these patterns in more detail, we can look at the breakdown of missing values for the variables, based on the levels of a grouping variable. 

**Figure A: Variables without skip option by Sex**

Notes: 
- Q58 (Partner) seems to have less missing values for males

```{r missingVal_By_Sex, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=100, fig.height=40}
cat('<div style="
  width: 100%;
  height: 600px; 
  overflow-x: scroll;
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

selectDF <- rawDF %>% 
        select(
                Sex, H6, H7H, H18, H19, H19A, H20,
                Q58, Q21)

miss_by_sex <- selectDF %>%
  gg_miss_fct(Sex) +
  scale_fill_gradientn(
    guide = "colorbar",
    name = "% Miss",
    colors = book_colors[c(3, 2, 1)]
  ) +
  ylab("Variable") +
  xlab("Sex") +
  ggtitle("Missing Data by Sex")

# Save plot as temporary file with exact dimensions
temp_file <- tempfile(fileext = ".png")
ggsave(
  filename = temp_file,
  plot = miss_by_sex,
  width = 20,
  height = 6,
  dpi = 100
)
cat(paste0('<img src="', temp_file, '" style="display: block; max-width: none; width: 2000px;">'))
cat('</div>')
```
**Figure B: Variables without skip option by Age**

Notes: 
- Q58 (Partner) seems to have less missing values for younger individuals

```{r missingVal_By_Age, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=100, fig.height=40}
cat('<div style="
  width: 100%;
  height: 600px; 
  overflow-x: scroll;
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

selectDF <- rawDF %>% 
        select(
                Q2, H6, H7H, H18, H19, H19A, H20,
                Q58, Q21)

miss_by_age <- selectDF %>%
  gg_miss_fct(Q2) +
  scale_fill_gradientn(
    guide = "colorbar",
    name = "% Miss",
    colors = book_colors[c(3, 2, 1)]
  ) +
  ylab("Variable") +
  xlab("Age") +
  ggtitle("Missing Data by Age")

# Save plot as temporary file with exact dimensions
temp_file <- tempfile(fileext = ".png")
ggsave(
  filename = temp_file,
  plot = miss_by_age,
  width = 20,
  height = 6,
  dpi = 100
)
cat(paste0('<img src="', temp_file, '" style="display: block; max-width: none; width: 2000px;">'))
cat('</div>')
```


# **3. Recode Variables & Prepare Dataset for Analysis** 
```{r helperFunctions}
recode_bin <- function(x,
                      as_factor = FALSE,
                      levels = c(1,0),
                      labels = c("Yes", "No")) {
        out <- dplyr::case_when(
                x %in% c(98, 99) ~ NA_real_,
                x == 1           ~ 1,
                x == 2           ~ 0,
                TRUE             ~ NA_real_
        )
        if (as_factor) {
                factor(out, levels = levels, labels = labels)
        } else {
                out
        }
}

recode_factor <- function(x, levels, labels){
        if (is.numeric(x) || is.integer(x)) {
                out <- case_when(
                        x %in% c(98,99) ~ NA_real_,
                        TRUE            ~ x
                )
                return(factor(out,
                              levels = levels,
                              labels = labels))
        }
        x_chr <- as.character(x)
        out <- case_when(
                x_chr %in% c("98", "99") ~ NA_character_,
                TRUE                     ~ x_chr
        )
        factor(out,
               levels = as.character(levels),
               labels = labels)
}

recode_copy <- function(x) {
        case_when(
                x %in% c(98, 99) ~ NA_real_,
                TRUE ~ as.numeric(x)
        )
}
reverse_n <- function(x, n,
                      as_factor = TRUE,
                      levels = seq(0, n),
                      labels = as.character(levels)){
        out <- case_when(
                x %in% c(98, 99)   ~ NA_real_,
                x >= 1 & x <= n    ~ (n + 1) - x,
                TRUE               ~ NA_real_
        )
        if (as_factor) {
                factor(out, levels = levels, labels = labels)
        } else {
                out
        }
}
reverse_3 <- function(x, ...) reverse_n(x, 3, ...)
reverse_4 <- function(x, ...) reverse_n(x, 4, ...)
reverse_5 <- function(x, ...) reverse_n(x, 5, ...)

```

```{r prepare labels}
ethLabels = c("INDIGENOUS",
              "GYPSY (ROMA)",
              "RAIZAL OF THE ARCHIPELAGO",
              "PALENQUERO OF SAN BASILIO",
              "BLACK/MULATO/AFROCOLOMBIAN OR AFRODESCENDANT",
              "MESTIZO",
              "NONE OF THE ABOVE")
ParentAbsLabels = c("YES, PARENT DIED",
                    "YES, PARENT IS SICK",
                    "YES, PARENT MOVED AWAY",
                    "YES PARENT IS IN JAIL",
                    "NO")
VictimRegTypeLabels = c("ABANDONMENT OR DISPOSSESSION OF LAND",
                        "TERRORIST ACT/ COMBAT",
                        "THREATS",
                        "CRIMES AGAINST SEXUAL LIBERTY OR INTEGRITY",
                        "FORCED DISAPPEARANCE",
                        "INTERNAL DISPLACEMENT",
                        "HOMICIDE",
                        "ANTIPERSONNEL MINES, UXOS",
                        "LOSS OF PROPERTY",
                        "KIDNAPPING",
                        "TORTURE",
                        "CHILDREN/ADOLESCENT")
MoneyWorryLabels = c("VERY OFTEN",
                     "OFTEN",
                     "SOMETIMES",
                     "SELDOM",
                     "NEVER")
FriendLabels = c("A LOT",
                 "SOME",
                 "NOT VERY MUCH",
                 "NOT AT ALL")
CloseLabels = c("VERY CLOSE",
                "CLOSE",
                "NOT CLOSE",
                "NO RELATIONSHIP")
MonitLabels = c("A LOT",
                "A LITTLE",
                "NOTHING")
SexOrientLabels = c("MEN",
                    "WOMEN",
                    "BOTH MEN AND WOMEN",
                    "NONE")
MHLabels = c("ALL THE TIME",
             "MOST OF THE TIME",
             "SOME OF THE TIME",
             "A LITTLE OF THE TIME",
             "NONE OF THE TIME")
SexTransactTypeLabels <- c(
  A = "Male Friend/Neighbor",
  B = "Male Teacher",
  C = "Male Community Leader",
  D = "Male Religious Leader",
  E = "Male Employer",
  F = "Boyfriend/Ex-Boyfriend/Romantic Partner/Ex-Romantic Partner",
  G = "Male classmate/schoolmate",
  H = "Male Police/Soldier/Security Person",
  I = "Male relative",
  J = "Male tourist or non-national",
  K = "Male stranger",
  L = "Male criminal gang member",
  M = "Male I met on the internet",
  N = "Female Friend/Neighbor",
  O = "Female Teachers",
  P = "Female community leader",
  Q = "Female religious leader",
  R = "Female employer",
  S = "Girlfriend/Ex-Girlfriend/Romantic Partner/Ex-Romantic Partner",
  T = "Female Classmate/Schoolmate",
  U = "Female Police/Soldier/Security Person",
  V = "Female Relative",
  W = "Female Tourist or Non-National",
  X = "Female Stranger",
  `1` = "Female Criminal Gang Member",
  `2` = "Female I met on the internet"
)
```

``` {r mutate }
df <- VACSData %>%
        select(-starts_with("Parenphys"),
               -starts_with("Nonparenphys")) %>%
        mutate(
                Sex = recode_bin(Sex, labels = c("Male", "Female"), as_factor = TRUE),
                Ethnicity = recode_factor(
                        Q2A,
                        levels = 1:7,
                        labels = ethLabels),
                Age = recode_copy(Q2),
                School = recode_bin(Q3),
                SharedHouse  = recode_bin(H6),
                InternetHome = recode_bin(H7H),
                GovSupport = recode(case_when(
                        H18 == 1 | H19 == 1                        ~1,
                        H18 == 2 & H19 != 1 | H19 == 2 & H18 != 1  ~0,
                        
                        H18 %in% c(98,99) & H19
                        Q31 %in% c(98, 99)   ~NA_real_, 
                                  Q31 == 11            ~0, 
                        )),
                NGOSupport = recode_bin(H19),
                VictimReg = recode_bin(H19A),
                ParentAbs = recode_factor(
                        H54,
                        levels = 1:5,
                        labels = ParentAbsLabels),
                ChildOutHome = recode_bin(H56),
                ChildStreet = recode_bin(H58),
                MoneyWorry = recode_factor(
                        H20,
                        levels = 1:5,
                        labels = MoneyWorryLabels),
                MoneyWorryCont = reverse_5(H20, as_factor = FALSE),
                Employed = recode_bin(Q13),
                MomAlive = recode_bin(Q19),
                DadAlive = recode_bin(Q29),
                Partner = recode_bin(Q58),
                SafetyVio = recode_bin(Q70),
                SafetyWar = recode_bin(Q71),
                MomAway = recode_bin(
                        case_when(Q21 %in% c(98, 99)   ~NA_real_,
                                  Q21 == 11            ~2,
                                  Q21 >= 1 & Q21 <= 10 ~1,
                                  TRUE                 ~NA_real_
                                  )),
                DadAway = recode_bin(
                        case_when(Q31 %in% c(98, 99)   ~NA_real_, 
                                  Q31 == 11            ~0, 
                                  Q31 >= 1 & Q31 <= 10 ~1)),
                Friend = recode_factor(Q7,
                                       levels = 1:4,
                                       labels = FriendLabels),
                FriendCont = reverse_4(Q7, as_factor = FALSE),
                ParMonitFreeTime = recode_factor(Q36E,
                                                levels = 1:3,
                                                labels = MonitLabels),
                ParMonitContFreeTime = reverse_3(Q36E, as_factor = FALSE),
                
                SexOrient = recode_factor(Q59,
                                          levels = 1:4,
                                          labels = SexOrientLabels),
                
                WitnessParIPV = recode_bin(
                        case_when(Q80 %in% c(98, 99) ~ NA_real_, 
                                  Q80 == 1           ~2,
                                  Q80 == 2           ~1,
                                  Q80 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                WitnessSibAbuse = recode_bin(
                        case_when(Q82 %in% c(98, 99) ~ NA_real_, 
                                  Q82 == 1           ~2,
                                  Q82 == 2           ~1,
                                  Q82 == 3           ~1,
                                  Q82 == 4           ~NA_real_,
                                  TRUE               ~NA_real_
                                  )),
                WitnessComVio = recode_bin(
                        case_when(Q84 %in% c(98, 99) ~ NA_real_, 
                                  Q84 == 1           ~2,
                                  Q84 == 2           ~1,
                                  Q84 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                WitnessArmConflict = recode_bin(
                        case_when(Q86 %in% c(98, 99) ~ NA_real_, 
                                  Q86 == 1           ~2,
                                  Q86 == 2           ~1,
                                  Q86 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                SexAct =  recode_bin(Q407),
                FirstSexWanted = recode_bin(Q409),
                SexTransact = recode_bin(Q500),

                SexAbuse = recode_bin(Q600),
                PartAttemptRape = recode_bin(Q700A),
                ElseAttemptRape = recode_bin(Q700B),
                PartCompleteRape = recode_bin(Q800A),
                ElseCompleteRape = recode_bin(Q800B),
                Drugs = recode_bin(Q1205),
                SelfHarm = recode_bin(Q1207),
                SuicideIdea = recode_bin(Q1208),
                SuicideAttempt = recode_bin(Q1209),
                STI = recode_bin(Q1210),
                Alcohol = recode_bin(
                        case_when(Q1200 %in% c(98, 99) ~ NA_real_,
                                  Q1200 == 97          ~ 2,
                                  is.na(Q1200)         ~ NA_real_,
                                  TRUE                 ~ 1)),
                across(
                        .cols = paste0("Q100", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "IPVPhys{which(paste0('Q100', LETTERS[1:4]) == .col)}"
                ),
                across(
                        .cols = paste0("Q116", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "PeerPhys{which(paste0('Q116', LETTERS[1:4]) == .col)}"
                ),
                across(
                        .cols = paste0("Q128", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "ParentPhys{which(paste0('Q128', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q142", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "NonParentPhys{which(paste0('Q142', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q300", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "ParentEmotAbuse{which(paste0('Q300', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q305", LETTERS[1:6]),
                        .fns = ~ recode_bin(.x),
                        .names = "IPVEmot{which(paste0('Q305', LETTERS[1:6]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q1206", LETTERS[1:6]),
                        .fns = ~ reverse_5(.x, as_factor = FALSE),
                        .names = "MH{substr(.col, 6, 6)}"
                        
                ),
                PhysCorp = recode_bin(Q400B),
                SexPartners = recode_copy(Q417),
                SexTransactTourist = recode_bin(
                        case_when(Q503 %in% c("J", "W")       ~ 1,
                                        Q503 %in% c("Z", "Y") ~ NA_real_,
                                        is.na(Q503)           ~ NA_real_,
                                        TRUE                  ~ 2
                        )),
                               ~ .x == 0),
                        na.rm = FALSE
                ),
                AllIPVPhys = rowSums(
                        across(starts_with("IPVPhys"),
                               ~.x == 1),
                        na.rm =FALSE
                ),
                AllNonParentPhys = rowSums(
                        across(starts_with("NonParentPhys"),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                AllParentEmotAbuse = rowSums(
                        across(starts_with("ParentEmotAbuse"),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                AllIPVEmot = rowSums(
                        across(starts_with("IPVEmot"),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                AllPeerPhys = rowSums(
                        across(starts_with("PeerPhys"),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                AllParentPhys = rowSums(
                        across(starts_with("ParentPhys"),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                AllMHsxs = rowSums(
                        across(
                                .cols = paste0("MH", LETTERS[1:6]),
                                ~ 5 - as.integer(.x)
                        ),
                        na.rm = FALSE
                ),
                WitnessAnyVio = rowSums(
                        across(c(WitnessParIPV, WitnessSibAbuse, WitnessComVio, WitnessArmConflict),
                                ~.x == 1),
                        na.rm = FALSE
                ),
                AllPhysViolence = rowSums(
                        across(c(AllIPVPhys, AllPeerPhys, AllParentPhys, AllNonParentPhys),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                SexAbuseBroad = rowSums(
                        across(c(SexAbuse, PartAttemptRape, ElseAttemptRape, PartCompleteRape, ElseCompleteRape),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                SexAbuseNarrow = rowSums(
                        across(c(SexAbuse, PartCompleteRape, ElseCompleteRape),
                               ~.x == 1),
                        na.rm = FALSE
                ),
                IPVTotal = rowSums(
                        across(c(AllIPVPhys, AllIPVEmot),
                               ~.x == 1),
                        na.rm = FALSE
                ),
  ) %>% select(
          VACS_ID,
        USM,
        Sex,
        Ethnicity,
        Age,
        DEPT,
        MUNI,
        PSU,
        HH,
        Wght_final,
        School,
        SharedHouse,
        InternetHome,
        GovSupport,
        NGOSupport,
        VictimReg,
        ParentAbs,
        ChildOutHome,
        ChildStreet,
        MoneyWorry,
        MoneyWorryCont,
        Employed,
        MomAlive,
        DadAlive,
        Partner,
        SafetyVio,
        SafetyWar,
        MomAway,
        DadAway,
        Friend,
        FriendCont,
        ParMonitFreeTime,
        ParMonitContFreeTime,
        SexOrient,
        WitnessParIPV,
        WitnessSibAbuse,
        WitnessComVio,
        WitnessArmConflict,
        SexAct,
        FirstSexWanted,
        SexTransact,
        SexAbuse,
        PartAttemptRape,
        ElseAttemptRape,
        PartCompleteRape,
        ElseCompleteRape,
        Drugs,
        SelfHarm,
        SuicideIdea,
        SuicideAttempt,
        STI,
        Alcohol,
        IPVPhys1,
        IPVPhys2,
        IPVPhys3,
        IPVPhys4,
        PeerPhys1,
        PeerPhys2,
        PeerPhys3,
        PeerPhys4,
        ParentPhys1,
        ParentPhys2,
        ParentPhys3,
        ParentPhys4,
        NonParentPhys1,
        NonParentPhys2,
        NonParentPhys3,
        NonParentPhys4,
        ParentEmotAbuse1,
        ParentEmotAbuse2,
        ParentEmotAbuse3,
        ParentEmotAbuse4,
        IPVEmot1,
        IPVEmot2,
        IPVEmot3,
        IPVEmot4,
        IPVEmot5,
        IPVEmot6,
        MHA,
        MHB,
        MHC,
        MHD,
        MHE,
        MHF,
        PhysCorp,
        SexPartners,
        SexTransactTourist,
        AllIPVPhys,
        AllNonParentPhys,
        AllParentEmotAbuse,
        AllParentPhys,
        AllIPVEmot,
        AllMHsxs,
        WitnessAnyVio,
        AllPhysViolence,
        SexAbuseBroad,
        SexAbuseNarrow,
        IPVTotal)
```

``` {r label}
df <- set_variable_labels(df,
                            Sex = "Sex of respondent",
                            Age = "Age of respondent",
                            Ethnicity = "Ethnic Self-Identification",
                            School = "Ever attended school/education centre/university?",
                            DEPT = "Department",
                            MUNI = "Municipality/Commune",
                            PSU = "Primary Sampling Unit (Enumeration Areas)",
                            USM = "Number of Segments",
                            HH = "Household Number",
                            VACS_ID = "Unique respondent ID",
                            Wght_final = "Final sampling weight",
                            SharedHouse = "Household shares toilet facilities with other households",
                            InternetHome = "Household has access to internet",
                            GovSupport = "Member of household receives financial government assistance",
                            NGOSupport = "Member of household receives financial non-government assistance",
                            VictimReg = "Member of household been included in National Victim's Registry",
                            ParentAbs = "Respondent <18 living in household because parent is sick, died, moved away, or imprisoned",
                            ChildOutHome = "Respondent <18 lived outside family care in past 5 years",
                            ChildStreet = "Respondent <18 lived on the street in past 5 years",
                            MoneyWorry = "Family worry about affording food in past 12 months",
                            MoneyWorryCont = "Family worry about affording food in past 12 months on scale from 0 to 5",
                            FoodSecure = "Household food security",
                            Employed = "Employed anytime within past 12 months",
                            MomAlive = "Bio mom alive",
                            DadAlive = "Bio dad alive",
                            Partner = "Ever had a boyfriend or romantic partner",
                            SafetyVio = "Ever left school/home due to fear of community violence",
                            SafetyWar = "Ever left school/home due to fear of police/military",
                            MomAway = "Bio mom ever lived far away",
                            DadAway = "Bio dad ever lived far away",
                            Friend = "Closeness to friends",
                            FriendCont = "Closeness to friends on scale from 0 to 4",
                            BasicSecure = "Basic need security",
                            HousingSecure = "Housing security",
                            ExtraMoneySecure = "Extra money security",
                            ParMonitFreeTime = "Parents Monitor Free Time",
                            ParMonitContFreeTime = "Parents Monitor Free Time on scale from 0 to 3",
                            SexOrient = "Sexual Orientation",
                            WitnessParIPV = "Witness parental IPV",
                            WitnessSibAbuse = "Witnessing sibling abuse",
                            WitnessComVio = "Witness violence in community",
                            WitnessArmConflict = "Witness armed conflict",
                            SexAct = "Ever had sex",
                            FirstSexWanted = "First sexual experience wanted",
                            SexTransact = "Ever involved in transactional sex",
                            SexAbuse = "Ever been sexually touched when not wanted",
                            PartAttemptRape = "Partner attempted rape",
                            ElseAttemptRape = "Anyone else attempted rape",
                            PartCompleteRape = "Partner rape",
                            ElseCompleteRape = "Anyone else rape",
                            Drugs = "Used drugs in 30 days",
                            SelfHarm = "Self harmed",
                            SuicideIdea = "Wanted to be dead",
                            SuicideAttempt = "Suicide attempt",
                            STI = "Ever had STI",
                            Alcohol = "Ever drank alcohol",
                            IPVPhys1 = "Intimate partner Physical violence 1",
                            IPVPhys2 = "Intimate partner Physical violence 2",
                            IPVPhys3 = "Intimate partner Physical violence 3",
                            IPVPhys4 = "Intimate partner Physical violence 4",
                            PeerPhys1 = "Peer Physical violence 1",
                            PeerPhys2 = "Peer Physical violence 2",
                            PeerPhys3 = "Peer Physical violence 3",
                            PeerPhys4 = "Peer Physical violence 4",
                            ParentPhys1 = "Parent, adult caregiver and other adult relative Physical violence 1",
                            ParentPhys2 = "Parent, adult caregiver and other adult relative Physical violence 2",
                            ParentPhys3 = "Parent, adult caregiver and other adult relative Physical violence 3",
                            ParentPhys4 = "Parent, adult caregiver and other adult relative Physical violence 4",
                            NonParentPhys1 = "Adult in community/neighborhood Physical violence 1",
                            NonParentPhys2 = "Adult in community/neighborhood Physical violence 2",
                            NonParentPhys3 = "Adult in community/neighborhood Physical violence 3",
                            NonParentPhys4 = "Adult in community/neighborhood Physical violence 4",
                            ParentEmotAbuse1 = "Parent, adult caregiver and other adult relative emotional violence 1",
                            ParentEmotAbuse2 = "Parent, adult caregiver and other adult relative emotional violence 2",
                            ParentEmotAbuse3 = "Parent, adult caregiver and other adult relative emotional violence 3",
                            ParentEmotAbuse4 = "Parent, adult caregiver and other adult relative emotional violence 4",
                            IPVEmot1 = "Intimate partner emotional violence 1",
                            IPVEmot2 = "Intimate partner emotional violence 2",
                            IPVEmot3 = "Intimate partner emotional violence 3",
                            IPVEmot4 = "Intimate partner emotional violence 4",
                            IPVEmot5 = "Intimate partner emotional violence 5",
                            IPVEmot6 = "Intimate partner emotional violence 6",
                            MHA = "Mental health: Nervousness",
                            MHB = "Mental health: Hopeless/anxious",
                            MHC = "Mental health: Restless",
                            MHD = "Mental health: Extreme Sadness",
                            MHE = "Mental health: Increased Effort",
                            MHF = "Mental health: Worthlessness",
                            PhysCorp = "Physical corporal punishment parent",
                            SexInitAge = "Age when first had sex",
                            SexPartners = "Number of sexual partners",
                            SexTransactTourist = "Whether transactional sex initiator was a tourist",
                            AllInsecure = "Food, Basic, Housing, or Extra Money Insecurity on a scale from 0 to 4",
                            AllMonit = "All parental monitoring on a scale from 0 to 15",
                            AllIPVPhys = "All intimate partner physical violence",
                            AllNonParentPhys = "All adult in community/neighborhood physical violence",
                            AllParentEmotAbuse = "All parent, adult caregiver and other adult relative emotional violence",
                            AllParentPhys = "All parent, adult caregiver and other adult relative physical violence",
                            AllIPVEmot = "All intimate partner emotional violence",
                            AllMHsxs = "All self-reported mental health concerns",
                            WitnessAnyVio = "Witnessed any abuse, violence, or community conflict",
                            AllPhysViolence = "Experienced any physical violence",
                            SexAbuseBroad = "Reported sexual abuse including attempted rape",
                            SexAbuseNarrow = "Reported sexual abuse excluding attempted rape",
                            IPVTotal = "Experienced any physical or emotional violence"
)
```

# **4. Inspect un-weighted data prior to survey analysis**

Ensure that there are no blatant outliers or unexpected missing values before proceeding to analysis.

```{r skimDF, echo=FALSE}
SkimData <- df %>% 
        select(- c("VACS_ID","Wght_final","PSU","DEPT","MUNI","HH","USM"))
skim_df <- skim_to_wide(SkimData)

datatable(
  skim_df,
  filter  = "top",
  options = list(
    pageLength = 10,
    scrollX    = TRUE,
    scrollY    = "400px"
  ),
  rownames = FALSE
)
```

```{r plotsHist, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
cat('<div style="
  height: 500px; 
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

cont_vars <- names(SkimData)[sapply(SkimData, is.numeric)]

for (v in cont_vars) {
  p <- ggplot(df, aes_string(x = v)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
    labs(title = paste("Histogram: ", v), x = v, y = "Count") +
    theme_minimal()
  print(p)
}

cat('</div>')
```

```{r plotsBar, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
cat('<div style="
  height: 500px; 
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

cat_vars  <- names(SkimData)[!sapply(SkimData, is.numeric)]

for (v in cat_vars) {
  p <- df %>%
    count(!!sym(v)) %>%
    ggplot(aes_string(x = v, y = "n")) +
    geom_bar(stat = "identity", fill = "tomato") +
    labs(title = paste("Bar chart: ", v), x = v, y = "Count") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)
}

cat('</div>')
```

# **5. Prepare filter variables**

Prepare the age and CSEC filters to be used during the analysis. The variable `CSEC` is a binarized variable that is set to `1` if the respondent was between the ages of 13 and 17 when they reported a history of transactional sex, or if the respondent was 18 or older but reported a history of transactional sex that first occurred when they were under 18. Otherwise, `CSEC` = `0`.

```{r filters}
df <- df %>% 
  mutate(
   Age13to17 = if_else(
     Age >= 13 & Age <= 17, 1L, 0L
   ),
   Age18Plus = if_else(
     Age >= 18 , 1L, 0L
   ),
   CSEC = case_when(
     SexTransact == 1 & Age13to17 == 1               ~ 1,
     SexTransact == 1 & Age18Plus == 1 & SexTransactAge <= 17  ~ 1,
     TRUE                                                 ~ 0
   )
  )

df <- set_variable_labels(df,
                          Age13to17 = "Filter: 'Age >= 13 & Age <=17' = 1; Else = 0",
                          Age18Plus = "Filter: 'Age >= 18' = 1; Else = 0 ",
                          CSEC = "Filter: 'Reported underage commercial sexual exploitation' = 1; Else = 0"
)
  
```

# **6. Save Prepared Data**

The cleaned and structured dataset ready for analysis is saved under the sub-directory 'data', and is named "Colombia_VACS_National_data_CLEANED". It is saved in '.rds'(R's native file format), '.sav' and '.csv' format.
```{r saveData}

write.csv(df, here::here("data", "Colombia_VACS_National_data_CLEANED.csv"), row.names = FALSE)
write_sav(df, here::here("data", "Colombia_VACS_National_data_CLEANED.sav"))
saveRDS(df, here::here("data","Colombia_VACS_National_data_CLEANED.rds"))
```


# **References & Resources**

-   Lumley, T. (2010). Complex Surveys: A Guide to Analysis Using R. Wiley.
-   Bruin, J. (2006). Survey Data Analysis With R. UCLA: Statistical Consulting Group. <https://stats.oarc.ucla.edu/r/seminars/survey-data-analysis-with-r/>
-   Lumley, T., Gao, P., & Schneider, B. (2019). survey: Analysis of Complex Survey Samples (R Package Manual). CRAN. <https://cran.r-project.org/web/packages/survey/survey.pdf>
-   Freedman, G., Lumley, T., Zoltak, T., Schneider, B., & Krivitsky, P.(2024). srvyr: 'dplyr'-like syntax for survey analysis (R Package Manual). CRAN. <https://cran.r-project.org/web/packages/srvyr/srvyr.pdf>
-   Lohr, S. L. (2010). Sampling: Design and Analysis (2nd ed.). Boston, MA: Brooks/Cole.
