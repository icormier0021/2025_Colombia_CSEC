---
title: "CSECT 2018 VACS Analysis- National Stratum"
author: "Isaac Cormier"
date: "7/25/2025"
output:
  html_document:
    self_contained: true
    code_download: yes
    code_folding: hide
    theme:
      bslib: yes
    toc: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '5'
params:
  data: ./Colombia VACS SPSS data.sav
---

```{css, echo = FALSE}
table caption {
  caption-side: top !important;
}
```

```{r setup, include=FALSE}
library(fs)
#knitr::opts_knit$set(root.dir = fs::path_dir(knitr::current_input()))

options(repos = c(CRAN = "https://cloud.r-project.org"))
knitr::opts_chunk$set(echo = TRUE)

packages <- c("survey", "haven", "dplyr", "labelled", "tidyr", "DT", "skimr", "ggplot2", "knitr", "kableExtra", "svyweight", "purrr", "srvyr", "tibble")

if(!require("pacman"))install.packages("pacman")

pacman::p_load(char = packages, character.only = TRUE)
```

Below is the code and output for the prevalence of the CSEC analysis of the national 2018 Colombia VACS sample. I've annotated the steps I've taken for convenience.    
Code sections are set to 'hide' by deafult; to see the code that was used to generate each section, select the 'show' button on the right hand side. Please note that much of the base `survey()` or `srvyr()`commands are wrapped in functions and workflows for rendering the data for RMarkdown. 

#  **1. Load and Clean Data**
Import the SPSS VACS dataset and prepare a cleaned dataframe for analysis. This includes recoding variables into binary or factor formats, creating summary variables, and ensuring everything is labeled. For categorical variables with scaled levels (e.g., `MomClose`, `DadClose`), continuous, reverse-coded versions were added for use when computing the summary variables.

The cleaned and structured dataset is saved in SPSS format as "R_Colombia_VACS_National_df.sav".

```{r loadData}
VACSData <- read_sav(params$data)
```

```{r helperFunctions}
recode_bin <- function(x,
                      as_factor = FALSE,
                      levels = c(1,0),
                      labels = c("Yes", "No")) {
        out <- dplyr::case_when(
                x %in% c(98, 99) ~ NA_real_,
                x == 1           ~ 1,
                x == 2           ~ 0,
                TRUE             ~ NA_real_
        )
        if (as_factor) {
                factor(out, levels = levels, labels = labels)
        } else {
                out
        }
}

recode_factor <- function(x, levels, labels){
        if (is.numeric(x) || is.integer(x)) {
                out <- case_when(
                        x %in% c(98,99) ~ NA_real_,
                        TRUE            ~ x
                )
                return(factor(out,
                              levels = levels,
                              labels = labels))
        }
        x_chr <- as.character(x)
        out <- case_when(
                x_chr %in% c("98", "99") ~ NA_character_,
                TRUE                     ~ x_chr
        )
        factor(out,
               levels = as.character(levels),
               labels = labels)
}

recode_copy <- function(x) {
        case_when(
                x %in% c(98, 99) ~ NA_real_,
                TRUE ~ as.numeric(x)
        )
}
reverse_n <- function(x, n,
                      as_factor = TRUE,
                      levels = seq(0, n),
                      labels = as.character(levels)){
        out <- case_when(
                x %in% c(98, 99)   ~ NA_real_,
                x >= 1 & x <= n    ~ (n + 1) - x,
                TRUE               ~ NA_real_
        )
        if (as_factor) {
                factor(out, levels = levels, labels = labels)
        } else {
                out
        }
}
reverse_3 <- function(x, ...) reverse_n(x, 3, ...)
reverse_4 <- function(x, ...) reverse_n(x, 4, ...)
reverse_5 <- function(x, ...) reverse_n(x, 5, ...)

```

```{r recode}
ethLabels = c("INDIGENOUS",
              "GYPSY (ROMA)",
              "RAIZAL OF THE ARCHIPELAGO",
              "PALENQUERO OF SAN BASILIO",
              "BLACK/MULATO/AFROCOLOMBIAN OR AFRODESCENDANT",
              "MESTIZO",
              "NONE OF THE ABOVE")
ParentAbsLabels = c("YES, PARENT DIED",
                    "YES, PARENT IS SICK",
                    "YES, PARENT MOVED AWAY",
                    "YES PARENT IS IN JAIL",
                    "NO")
VictimRegTypeLabels = c("ABANDONMENT OR DISPOSSESSION OF LAND",
                        "TERRORIST ACT/ COMBAT",
                        "THREATS",
                        "CRIMES AGAINST SEXUAL LIBERTY OR INTEGRITY",
                        "FORCED DISAPPEARANCE",
                        "INTERNAL DISPLACEMENT",
                        "HOMICIDE",
                        "ANTIPERSONNEL MINES, UXOS",
                        "LOSS OF PROPERTY",
                        "KIDNAPPING",
                        "TORTURE",
                        "CHILDREN/ADOLESCENT")
MoneyWorryLabels = c("VERY OFTEN",
                     "OFTEN",
                     "SOMETIMES",
                     "SELDOM",
                     "NEVER")
FriendLabels = c("A LOT",
                 "SOME",
                 "NOT VERY MUCH",
                 "NOT AT ALL")
CloseLabels = c("VERY CLOSE",
                "CLOSE",
                "NOT CLOSE",
                "NO RELATIONSHIP")
MonitLabels = c("A LOT",
                "A LITTLE",
                "NOTHING")
SexOrientLabels = c("MEN",
                    "WOMEN",
                    "BOTH MEN AND WOMEN",
                    "NONE")
MHLabels = c("ALL THE TIME",
             "MOST OF THE TIME",
             "SOME OF THE TIME",
             "A LITTLE OF THE TIME",
             "NONE OF THE TIME")
SexTransactTypeLabels <- c(
  A = "Male Friend/Neighbor",
  B = "Male Teacher",
  C = "Male Community Leader",
  D = "Male Religious Leader",
  E = "Male Employer",
  F = "Boyfriend/Ex-Boyfriend/Romantic Partner/Ex-Romantic Partner",
  G = "Male classmate/schoolmate",
  H = "Male Police/Soldier/Security Person",
  I = "Male relative",
  J = "Male tourist or non-national",
  K = "Male stranger",
  L = "Male criminal gang member",
  M = "Male I met on the internet",
  N = "Female Friend/Neighbor",
  O = "Female Teachers",
  P = "Female community leader",
  Q = "Female religious leader",
  R = "Female employer",
  S = "Girlfriend/Ex-Girlfriend/Romantic Partner/Ex-Romantic Partner",
  T = "Female Classmate/Schoolmate",
  U = "Female Police/Soldier/Security Person",
  V = "Female Relative",
  W = "Female Tourist or Non-National",
  X = "Female Stranger",
  `1` = "Female Criminal Gang Member",
  `2` = "Female I met on the internet"
)

df <- VACSData %>%
        select(-starts_with("Parenphys"),
               -starts_with("Nonparenphys")) %>%
        mutate(
                Sex = recode_bin(Sex, labels = c("Male", "Female"), as_factor = TRUE),
                Ethnicity = recode_factor(
                        Q2A,
                        levels = 1:7,
                        labels = ethLabels),
                Age = recode_copy(Q2),
                School = recode_bin(Q3),
                SharedHouse  = recode_bin(H6),
                InternetHome = recode_bin(H7H),
                GovSupport = recode_bin(H18),
                NGOSupport = recode_bin(H19),
                VictimReg = recode_bin(H19A),
                ParentAbs = recode_factor(
                        H54,
                        levels = 1:5,
                        labels = ParentAbsLabels),
                ChildOutHome = recode_bin(H56),
                ChildStreet = recode_bin(H58),
                VictimRegType = recode_factor(
                        H19B,
                        levels = 1:12,
                        labels = VictimRegTypeLabels),
                MoneyWorry = recode_factor(
                        H20,
                        levels = 1:5,
                        labels = MoneyWorryLabels),
                MoneyWorryCont = reverse_5(H20, as_factor = FALSE),
                FoodSecure = recode_bin(Q7AA),
                Employed = recode_bin(Q13),
                MomAlive = recode_bin(Q19),
                DadAlive = recode_bin(Q29),
                Partner = recode_bin(Q58),
                SafetyVio = recode_bin(Q70),
                SafetyWar = recode_bin(Q71),
                BullyVic = recode_bin(Q306),
                MomAway = recode_bin(
                        case_when(Q21 %in% c(98, 99)   ~NA_real_,
                                  Q21 == 11            ~2,
                                  Q21 >= 1 & Q21 <= 10 ~1,
                                  TRUE                 ~NA_real_
                                  )),
                DadAway = recode_bin(
                        case_when(Q31 %in% c(98, 99)   ~NA_real_, 
                                  Q31 == 11            ~0, 
                                  Q31 >= 1 & Q31 <= 10 ~1)),
                Friend = recode_factor(Q7,
                                       levels = 1:4,
                                       labels = FriendLabels),
                FriendCont = reverse_4(Q7, as_factor = FALSE),
                MomClose = recode_factor(Q25,
                                         levels = 1:4,
                                         labels = CloseLabels),
                MomCloseCont = reverse_4(Q25, as_factor = FALSE),
                DadClose = recode_factor(Q35,
                                         levels = 1:4,
                                         labels = CloseLabels),
                DadCloseCont = reverse_4(Q35, as_factor = FALSE),
                BasicSecure = recode_bin(Q7AB),
                HousingSecure = recode_bin(Q7AC),
                ExtraMoneySecure = recode_bin(Q7AD),
       
                ParMonitFriends = recode_factor(Q36A,
                                                levels = 1:3,
                                                labels = MonitLabels),
                ParMonitMoney = recode_factor(Q36B,
                                                levels = 1:3,
                                                labels = MonitLabels),
                ParMonitAftSchool = recode_factor(Q36C,
                                                levels = 1:3,
                                                labels = MonitLabels),
                ParMonitNight = recode_factor(Q36D,
                                                levels = 1:3,
                                                labels = MonitLabels),
                ParMonitFreeTime = recode_factor(Q36E,
                                                levels = 1:3,
                                                labels = MonitLabels),
                       
                ParMonitContFriends = reverse_3(Q36A, as_factor = FALSE),
                ParMonitContMoney = reverse_3(Q36B, as_factor = FALSE),
                ParMonitContAftSchool = reverse_3(Q36C, as_factor = FALSE),
                ParMonitContNight = reverse_3(Q36D, as_factor = FALSE),
                ParMonitContFreeTime = reverse_3(Q36E, as_factor = FALSE),
                
                SexOrient = recode_factor(Q59,
                                          levels = 1:4,
                                          labels = SexOrientLabels),
                
                WitnessParIPV = recode_bin(
                        case_when(Q80 %in% c(98, 99) ~ NA_real_, 
                                  Q80 == 1           ~2,
                                  Q80 == 2           ~1,
                                  Q80 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                WitnessSibAbuse = recode_bin(
                        case_when(Q82 %in% c(98, 99) ~ NA_real_, 
                                  Q82 == 1           ~2,
                                  Q82 == 2           ~1,
                                  Q82 == 3           ~1,
                                  Q82 == 4           ~NA_real_,
                                  TRUE               ~NA_real_
                                  )),
                WitnessComVio = recode_bin(
                        case_when(Q84 %in% c(98, 99) ~ NA_real_, 
                                  Q84 == 1           ~2,
                                  Q84 == 2           ~1,
                                  Q84 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                WitnessArmConflict = recode_bin(
                        case_when(Q86 %in% c(98, 99) ~ NA_real_, 
                                  Q86 == 1           ~2,
                                  Q86 == 2           ~1,
                                  Q86 == 3           ~1,
                                  TRUE               ~NA_real_
                                  )),
                SexAct =  recode_bin(Q407),
                FirstSexWanted = recode_bin(Q409),
                SexTransact = recode_bin(Q500),

                SexAbuse = recode_bin(Q600),
                PartAttemptRape = recode_bin(Q700A),
                ElseAttemptRape = recode_bin(Q700B),
                PartCompleteRape = recode_bin(Q800A),
                ElseCompleteRape = recode_bin(Q800B),
                Drugs = recode_bin(Q1205),
                SelfHarm = recode_bin(Q1207),
                SuicideIdea = recode_bin(Q1208),
                SuicideAttempt = recode_bin(Q1209),
                STI = recode_bin(Q1210),
                Alcohol = recode_bin(
                        case_when(Q1200 %in% c(98, 99) ~ NA_real_,
                                  Q1200 == 97          ~ 2,
                                  TRUE                 ~ 1)),
                across(
                        .cols = paste0("Q100", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "IPVPhys{which(paste0('Q100', LETTERS[1:4]) == .col)}"
                ),
                across(
                        .cols = paste0("Q116", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "PeerPhys{which(paste0('Q116', LETTERS[1:4]) == .col)}"
                ),
                across(
                        .cols = paste0("Q128", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "ParentPhys{which(paste0('Q128', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q142", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "NonParentPhys{which(paste0('Q142', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q300", LETTERS[1:4]),
                        .fns = ~ recode_bin(.x),
                        .names = "ParentEmotAbuse{which(paste0('Q300', LETTERS[1:4]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q305", LETTERS[1:6]),
                        .fns = ~ recode_bin(.x),
                        .names = "IPVEmot{which(paste0('Q305', LETTERS[1:6]) == .col)}"
                        
                ),
                across(
                        .cols = paste0("Q1206", LETTERS[1:6]),
                        .fns = ~ reverse_5(.x, as_factor = FALSE),
                        .names = "MH{substr(.col, 6, 6)}"
                        
                ),
                PhysCorp = recode_bin(Q400B),
                SexInitAge = recode_copy(Q408),
                SexPartners = recode_copy(Q417),
                SexTransactAge = recode_copy(Q504),
                SexTransactInitAge = recode_copy(Q505),
                SexTransactType = recode_factor(
                        Q503,
                        levels = names(SexTransactTypeLabels),
                        labels = unname(SexTransactTypeLabels)
                ),
                SexTransactTourist = recode_bin(
                        case_when(Q503 %in% c("J", "W")       ~ 1,
                                        Q503 %in% c("Z", "Y") ~ NA_real_,
                                        TRUE                  ~ 2
                        )),
                AllInsecure = rowSums(
                        across(c(FoodSecure, BasicSecure, HousingSecure, ExtraMoneySecure),
                               ~ .x == 0),
                        na.rm = TRUE
                ),
                AllMonit = rowSums(
                        across(starts_with("ParMonitCont"),
                               ~!is.na(.x)),
                        na.rm = TRUE
                ),
                AllIPVPhys = rowSums(
                        across(starts_with("IPVPhys"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllNonParentPhys = rowSums(
                        across(starts_with("NonParentPhys"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllParentEmotAbuse = rowSums(
                        across(starts_with("ParentEmotAbuse"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllIPVEmot = rowSums(
                        across(starts_with("IPVEmot"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllPeerPhys = rowSums(
                        across(starts_with("PeerPhys"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllParentPhys = rowSums(
                        across(starts_with("ParentPhys"),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                AllMHsxs = rowSums(
                        across(
                                .cols = paste0("MH", LETTERS[1:6]),
                                ~ 5 - as.integer(.x)
                        ),
                        na.rm = TRUE
                ),
                WitnessAnyVio = rowSums(
                        across(c(WitnessParIPV, WitnessSibAbuse, WitnessComVio, WitnessArmConflict),
                                ~.x == 1),
                        na.rm = TRUE
                ),
                AllPhysViolence = rowSums(
                        across(c(AllIPVPhys, AllPeerPhys, AllParentPhys, AllNonParentPhys),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                SexAbuseBroad = rowSums(
                        across(c(SexAbuse, PartAttemptRape, ElseAttemptRape, PartCompleteRape, ElseCompleteRape),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                SexAbuseNarrow = rowSums(
                        across(c(SexAbuse, PartCompleteRape, ElseCompleteRape),
                               ~.x == 1),
                        na.rm = TRUE
                ),
                IPVTotal = rowSums(
                        across(c(AllIPVPhys, AllIPVEmot),
                               ~.x == 1),
                        na.rm = TRUE
                ),
  ) %>% select(
          VACS_ID,
        USM,
        Sex,
        Ethnicity,
        Age,
        DEPT,
        MUNI,
        PSU,
        HH,
        Wght_final,
        School,
        SharedHouse,
        InternetHome,
        GovSupport,
        NGOSupport,
        VictimReg,
        ParentAbs,
        ChildOutHome,
        ChildStreet,
        VictimRegType,
        MoneyWorry,
        MoneyWorryCont,
        FoodSecure,
        Employed,
        MomAlive,
        DadAlive,
        Partner,
        SafetyVio,
        SafetyWar,
        BullyVic,
        MomAway,
        DadAway,
        Friend,
        FriendCont,
        MomClose,
        MomCloseCont,
        DadClose ,
        DadCloseCont,
        BasicSecure,
        HousingSecure,
        ExtraMoneySecure,
        ParMonitFriends,
        ParMonitMoney,
        ParMonitAftSchool,
        ParMonitNight,
        ParMonitFreeTime,
        ParMonitContFriends,
        ParMonitContMoney,
        ParMonitContAftSchool,
        ParMonitContNight,
        ParMonitContFreeTime,
        SexOrient,
        WitnessParIPV,
        WitnessSibAbuse,
        WitnessComVio,
        WitnessArmConflict,
        SexAct,
        FirstSexWanted,
        SexTransact,
        SexAbuse,
        PartAttemptRape,
        ElseAttemptRape,
        PartCompleteRape,
        ElseCompleteRape,
        Drugs,
        SelfHarm,
        SuicideIdea,
        SuicideAttempt,
        STI,
        Alcohol,
        IPVPhys1,
        IPVPhys2,
        IPVPhys3,
        IPVPhys4,
        PeerPhys1,
        PeerPhys2,
        PeerPhys3,
        PeerPhys4,
        ParentPhys1,
        ParentPhys2,
        ParentPhys3,
        ParentPhys4,
        NonParentPhys1,
        NonParentPhys2,
        NonParentPhys3,
        NonParentPhys4,
        ParentEmotAbuse1,
        ParentEmotAbuse2,
        ParentEmotAbuse3,
        ParentEmotAbuse4,
        IPVEmot1,
        IPVEmot2,
        IPVEmot3,
        IPVEmot4,
        IPVEmot5,
        IPVEmot6,
        MHA,
        MHB,
        MHC,
        MHD,
        MHE,
        MHF,
        PhysCorp,
        SexInitAge,
        SexPartners,
        SexTransactAge,
        SexTransactInitAge,
        SexTransactType,
        SexTransactTourist,
        AllInsecure,
        AllMonit,
        AllIPVPhys,
        AllNonParentPhys,
        AllParentEmotAbuse,
        AllParentPhys,
        AllIPVEmot,
        AllMHsxs,
        WitnessAnyVio,
        AllPhysViolence,
        SexAbuseBroad,
        SexAbuseNarrow,
        IPVTotal)

df <- set_variable_labels(df,
                            Sex = "Sex of respondent",
                            Age = "Age of respondent",
                            Ethnicity = "Ethnic Self-Identification",
                            School = "Ever attended school/education centre/university?",
                            DEPT = "Department",
                            MUNI = "Municipality/Commune",
                            PSU = "Primary Sampling Unit (Enumeration Areas)",
                            USM = "Number of Segments",
                            HH = "Household Number",
                            VACS_ID = "Unique respondent ID",
                            Wght_final = "Final sampling weight",
                            SharedHouse = "Household shares toilet facilities with other households",
                            InternetHome = "Household has access to internet",
                            GovSupport = "Member of household receives financial government assistance",
                            NGOSupport = "Member of household receives financial non-government assistance",
                            VictimReg = "Member of household been included in National Victim's Registry",
                            ParentAbs = "Respondent <18 living in household because parent is sick, died, moved away, or imprisoned",
                            ChildOutHome = "Respondent <18 lived outside family care in past 5 years",
                            ChildStreet = "Respondent <18 lived on the street in past 5 years",
                            VictimRegType = "Event that led to member of household being included on victim registry",
                            MoneyWorry = "Family worry about affording food in past 12 months",
                            MoneyWorryCont = "Family worry about affording food in past 12 months on scale from 0 to 5",
                            FoodSecure = "Household food security",
                            Employed = "Employed anytime within past 12 months",
                            MomAlive = "Bio mom alive",
                            DadAlive = "Bio dad alive",
                            Partner = "Ever had a boyfriend or romantic partner",
                            SafetyVio = "Ever left school/home due to fear of community violence",
                            SafetyWar = "Ever left school/home due to fear of police/military",
                            BullyVic = "Bullying victim",
                            MomAway = "Bio mom ever lived far away",
                            DadAway = "Bio dad ever lived far away",
                            Friend = "Closeness to friends",
                            FriendCont = "Closeness to friends on scale from 0 to 4",
                            MomClose = "Bio mom close",
                            MomCloseCont = "Bio mom close on scale from 0 to 4",
                            DadClose = "Bio dad close",
                            DadCloseCont = "Bio dad close on scale from 0 to 4",
                            BasicSecure = "Basic need security",
                            HousingSecure = "Housing security",
                            ExtraMoneySecure = "Extra money security",
                            ParMonitFriends = "Parents Monitor Friends",
                            ParMonitMoney = "Parents Monitor Spending",
                            ParMonitAftSchool = "Parents Monitor After School",
                            ParMonitNight = "Parents Monitor at Night",
                            ParMonitFreeTime = "Parents Monitor Free Time",
                            ParMonitContFriends = "Parents Monitor Friends on scale from 0 to 3",
                            ParMonitContMoney = "Parents Monitor Spending on scale from 0 to 3",
                            ParMonitContAftSchool = "Parents Monitor After School on scale from 0 to 3",
                            ParMonitContNight = "Parents Monitor at Night on scale from 0 to 3",
                            ParMonitContFreeTime = "Parents Monitor Free Time on scale from 0 to 3",
                            SexOrient = "Sexual Orientation",
                            WitnessParIPV = "Witness parental IPV",
                            WitnessSibAbuse = "Witnessing sibling abuse",
                            WitnessComVio = "Witness violence in community",
                            WitnessArmConflict = "Witness armed conflict",
                            SexAct = "Ever had sex",
                            FirstSexWanted = "First sexual experience wanted",
                            SexTransact = "Ever involved in transactional sex",
                            SexAbuse = "Ever been sexually touched when not wanted",
                            PartAttemptRape = "Partner attempted rape",
                            ElseAttemptRape = "Anyone else attempted rape",
                            PartCompleteRape = "Partner rape",
                            ElseCompleteRape = "Anyone else rape",
                            Drugs = "Used drugs in 30 days",
                            SelfHarm = "Self harmed",
                            SuicideIdea = "Wanted to be dead",
                            SuicideAttempt = "Suicide attempt",
                            STI = "Ever had STI",
                            Alcohol = "Ever drank alcohol",
                            IPVPhys1 = "Intimate partner Physical violence 1",
                            IPVPhys2 = "Intimate partner Physical violence 2",
                            IPVPhys3 = "Intimate partner Physical violence 3",
                            IPVPhys4 = "Intimate partner Physical violence 4",
                            PeerPhys1 = "Peer Physical violence 1",
                            PeerPhys2 = "Peer Physical violence 2",
                            PeerPhys3 = "Peer Physical violence 3",
                            PeerPhys4 = "Peer Physical violence 4",
                            ParentPhys1 = "Parent, adult caregiver and other adult relative Physical violence 1",
                            ParentPhys2 = "Parent, adult caregiver and other adult relative Physical violence 2",
                            ParentPhys3 = "Parent, adult caregiver and other adult relative Physical violence 3",
                            ParentPhys4 = "Parent, adult caregiver and other adult relative Physical violence 4",
                            NonParentPhys1 = "Adult in community/neighborhood Physical violence 1",
                            NonParentPhys2 = "Adult in community/neighborhood Physical violence 2",
                            NonParentPhys3 = "Adult in community/neighborhood Physical violence 3",
                            NonParentPhys4 = "Adult in community/neighborhood Physical violence 4",
                            ParentEmotAbuse1 = "Parent, adult caregiver and other adult relative emotional violence 1",
                            ParentEmotAbuse2 = "Parent, adult caregiver and other adult relative emotional violence 2",
                            ParentEmotAbuse3 = "Parent, adult caregiver and other adult relative emotional violence 3",
                            ParentEmotAbuse4 = "Parent, adult caregiver and other adult relative emotional violence 4",
                            IPVEmot1 = "Intimate partner emotional violence 1",
                            IPVEmot2 = "Intimate partner emotional violence 2",
                            IPVEmot3 = "Intimate partner emotional violence 3",
                            IPVEmot4 = "Intimate partner emotional violence 4",
                            IPVEmot5 = "Intimate partner emotional violence 5",
                            IPVEmot6 = "Intimate partner emotional violence 6",
                            MHA = "Mental health: Nervousness",
                            MHB = "Mental health: Hopeless/anxious",
                            MHC = "Mental health: Restless",
                            MHD = "Mental health: Extreme Sadness",
                            MHE = "Mental health: Increased Effort",
                            MHF = "Mental health: Worthlessness",
                            PhysCorp = "Physical corporal punishment parent",
                            SexInitAge = "Age when first had sex",
                            SexPartners = "Number of sexual partners",
                            SexTransactAge = "Age of respondent during first transactional sex",
                            SexTransactInitAge = "Age of initiator during first transactional sex ",
                            SexTransactTourist = "Whether transactional sex initiator was a tourist",
                            SexTransactType = "Identity of initiator during first transactional sex",
                            AllInsecure = "Food, Basic, Housing, or Extra Money Insecurity on a scale from 0 to 4",
                            AllMonit = "All parental monitoring on a scale from 0 to 15",
                            AllIPVPhys = "All intimate partner physical violence",
                            AllNonParentPhys = "All adult in community/neighborhood physical violence",
                            AllParentEmotAbuse = "All parent, adult caregiver and other adult relative emotional violence",
                            AllParentPhys = "All parent, adult caregiver and other adult relative physical violence",
                            AllIPVEmot = "All intimate partner emotional violence",
                            AllMHsxs = "All self-reported mental health concerns",
                            WitnessAnyVio = "Witnessed any abuse, violence, or community conflict",
                            AllPhysViolence = "Experienced any physical violence",
                            SexAbuseBroad = "Reported sexual abuse including attempted rape",
                            SexAbuseNarrow = "Reported sexual abuse excluding attempted rape",
                            IPVTotal = "Experienced any physical or emotional violence"
)
```
# **2. Inspect unweighted data prior to survey analysis**
Ensure that there are no blatant outliers or unexpected missing values before proceeding to analysis.

```{r skimDF, echo=FALSE}
SkimData <- df %>% 
        select(- c("VACS_ID","Wght_final","PSU","DEPT","MUNI","HH","USM"))
skim_df <- skim_to_wide(SkimData)

datatable(
  skim_df,
  filter  = "top",
  options = list(
    pageLength = 10,
    scrollX    = TRUE,
    scrollY    = "400px"
  ),
  rownames = FALSE
)
```

```{r plotsHist, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
cat('<div style="
  height: 500px; 
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

cont_vars <- names(SkimData)[sapply(SkimData, is.numeric)]

for (v in cont_vars) {
  p <- ggplot(df, aes_string(x = v)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
    labs(title = paste("Histogram: ", v), x = v, y = "Count") +
    theme_minimal()
  print(p)
}

cat('</div>')
```

```{r plotsBar, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
cat('<div style="
  height: 500px; 
  overflow-y: scroll; 
  border: 2px solid #ddd; 
  border-radius: 8px;
  padding: 15px; 
  background-color: #fafafa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">')

cat_vars  <- names(SkimData)[!sapply(SkimData, is.numeric)]

for (v in cat_vars) {
  p <- df %>%
    count(!!sym(v)) %>%
    ggplot(aes_string(x = v, y = "n")) +
    geom_bar(stat = "identity", fill = "tomato") +
    labs(title = paste("Bar chart: ", v), x = v, y = "Count") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)
}

cat('</div>')
```
# **3. Prepare filter variables**
Prepare the age and CSEC filters to be used during the analysis. The variable `CSEC` is a binarized variable that is set to `1` if the respondent was between the ages of 13 and 17 when they reported a history of transactional sex, or if the respondent was 18 or older but reported a history of transactional sex that first occured when they were under 18. Otherwise, `CSEC` = `0`.

```{r filters}
df <- df %>% 
  mutate(
   Age13to17 = if_else(
     Age >= 13 & Age <= 17, 1L, 0L
   ),
   Age18Plus = if_else(
     Age >= 18 , 1L, 0L
   ),
   CSEC = case_when(
     SexTransact == 1 & Age >= 13 & Age <= 17             ~ 1,
     SexTransact == 1 & Age >= 18 & SexTransactAge <= 17  ~ 1,
     TRUE                                                 ~ 0
   )
  )

df <- set_variable_labels(df,
                          Age13to17 = "Filter: Age >= 13 & Age <=17",
                          Age18Plus = "Filter: Age >= 18",
                          CSEC = "Filter: Reported commercial sexual exploitation as a child"
)
  
```
# **4. Specify Survey Design for Analyses**
Creates the survey design object, which incorporates the complex sampling structure of the VACS dataset. Design effect and effective sample size are calculated to show how well the population sample represents the target population. 

Note: The use of `~` indicates that the preceeding variable comes from the dataframe defined in the `data` argument
```{r keyTbl, echo=FALSE, warning=FALSE, message=FALSE}
key <- tibble(
  `Code Line` = c(
    "`id = ~PSU`",
    "`strata = ~DEPT`",
    "`weights = ~Wght_final`",
    "`data = data`",
    "`nest = TRUE`"
  ),
  Explanation = c(
    "Tells R that rather than sampling every individual independently, clusters were sampled first as groups. Since the National & Priority datasets are the first level clusters, the PSU variable is technically the Secondary Sampling Unit (SSU), and represents distinct enumeration areas. You may see SSU used in the VACS report rather than PSU, although they mean the same thing in this context.",
    "Tells R that the population was divided into non-overlapping subgroups called strata. VACS uses departments and municipalities to define strata.",
    "Tells R the final sampling weight calculated for each individual. This value is the inverse of the probability that individual was selected for the sample, adjusted for non-response and post-stratification.",
    "Tells R which dataset contains the survey data, inclduding the PSU, DEPT, and Wght_final variables.",
    "Tells R that the data contains nested clusters. In case there are repeating cluster values across the strata, R will make sure to treat them as distinct. This ensures that variance estimates are correct."
  )
)

key %>%
  kable(
    format    = "html",       
    booktabs  = FALSE,        
    linesep   = ""            
  ) %>%
  kable_styling(
    position    = "left", 
    full_width  = FALSE,
  )


```


```{r svyDesign}
vacsDesign <- df %>% 
  as_survey_design(
  id = PSU,
  strata = DEPT,
  weights = Wght_final,
  nest = TRUE
)
```

```{r sampleCharacteristics}

n <- nrow(df) #Unweighted sample size (i.e., number of respondents)
n_hat <- sum(weights(vacsDesign)) #Weighted population total
n_eff_wght <- eff_n(vacsDesign) #Kish effective sample size
wghtEfficiency <- n_eff_wght / n #Weighting efficiency 
designEffectWght <- 1/wghtEfficiency #Design effect due to weights

```


The 2018 VACS team collected information from **`r n`** respondents. 
After applying the final survey weights, the cases represent an estimated **`r comma(n_hat)`** individuals in the target population. Using Kish's (1965) formula, the effective sample size is approximately **`r round(n_eff_wght)`** when adjusting for unequal weights alone (not accounting for stratification or clustering), with a weighting efficiency of **`r percent(wghtEfficiency, accuracy = 0.1)`**. This means that the sample weights inflate the sampling variance by a factor of **`r sprintf('%.2f', designEffectWght)`**, and that the weights reduce statistical precision relative to simple-random sampling by approximately **`r percent(1-wghtEfficiency, accuracy = 0.1)`**.

Below is information about the survey design and the sample itself, such as the number of PSUs per strata using the `summary()` function

```{r showDes, echo=FALSE}
vacsDesign
```

# **5. CSEC Descriptives & Frequencies**
Prepares descriptive statistics on the prevalence of CSEC among respondents. All descriptives and frequencies are seperated by age (i.e., `Age13to17`, `Age18Plus`). Functions were set to remove any `NA` values from their calculations, so not to send back an error. 

```{r tblHelper, echo=FALSE}
createKable <- function(tbl, title = "My Title"){
  boundary_rows <- which(
    c(FALSE, tbl[[1]][-1] != tbl[[1]][-length(tbl[[1]])])
  )
  
  align_vec <- c("l", rep("r", ncol(tbl) - 1))
  
  kable(
    tbl,
    col.names = names(tbl),
    align     = align_vec,
    digits    = 4,        
    format    = "html",
    caption   = title
  ) %>%
    kable_styling(
      bootstrap_options = c("condensed", "bordered"),
      full_width        = FALSE,
      position          = "left"
    ) %>%
    column_spec(
      which(sapply(tbl, is.numeric)),
      width     = "60px",
      extra_css = "padding-left:6px; padding-right:6px;"
    ) %>% 
    row_spec(
      boundary_rows,
      extra_css = "border-top: 3px solid black;"
    ) %>%
        scroll_box(width = "1000px", height = "400px")
}

#Helper functions for calculating survey means, quantiles, totals, proportions and counts

calculateMean_Total <- function(var, design, filter_expr = NULL) {
  f <- rlang::enquo(filter_expr)
  var_label <- attr(design$variables[[var]], "label")
  if (is.null(var_label)) var_label <- "No Label Specified"
  design %>%
    { if (rlang::quo_is_null(f)) . else filter(., !!f) } %>% 
    summarise(
      Mean = survey_mean(!!sym(var), na.rm = TRUE, vartype=c("se", "cv", "ci"), deff = TRUE),
      Q25             = survey_quantile(!!sym(var), 0.25, na.rm = TRUE, vartype = "ci")[[1]],
      Median          = survey_quantile(!!sym(var), 0.50, na.rm = TRUE, vartype = "ci")[[1]],
      Q75             = survey_quantile(!!sym(var), 0.75, na.rm = TRUE, vartype = "ci")[[1]],
      TotalRespond    = sum(!is.na(!!sym(var))),
      TotalNA         = sum(is.na(!!sym(var))),
      Total           = survey_total(!!sym(var), na.rm = TRUE, vartype = c("se", "cv", "ci"))
    ) %>% 
    mutate(
      Variable = var,
      `Variable Label` = var_label
      ) %>% 
    rename(
      `Mean(SE)` = Mean_se,
      `Mean(CV)` = Mean_cv,
      `Mean(Low CI 95%)` = Mean_low,
      `Mean(Upp CI 95%)` = Mean_upp,
      `Mean(DeEff)` = Mean_deff,
      `Total(SE)` = Total_se,
      `Total(CV)` = Total_cv,
      `Total(Low CI 95%)` = Total_low,
      `Total(Upp CI 95%)` = Total_upp
    ) %>% 
    select(Variable,`Variable Label`, everything())
}

calculateCount <- function(var, design, filter_expr = NULL){
  f <- rlang::enquo(filter_expr)
  var_label <- attr(design$variables[[var]], "label")
  if (is.null(var_label)) var_label <- "No Label Specified"
  design %>% 
    drop_na(!!sym(var)) %>% 
    { if (rlang::quo_is_null(f)) . else filter(., !!f) } %>% 
    group_by(!!sym(var)) %>% 
    survey_count(!!sym(var), name = 'N', vartype = c("se", "ci", "cv")) %>%
    mutate(
      Variable = var,
      `Variable Label` = var_label
      ) %>% 
    rename(
      Answer = !!sym(var),
    `N(SE)` = N_se,
    `N (Lower CI 95%)` = N_low,
    `N (Upper CI 95%)` = N_upp,
    `N(CV)` = N_cv
    ) %>% 
    mutate(
      Answer = recode(
        Answer,
        `0` = "No",
        `1` = "Yes",
        .default = as.character(Answer)
        )
      ) %>% 
    select(Variable, `Variable Label`, everything())
}

calculateProp <- function(var, design, filter_expr = NULL) {
  f <- rlang::enquo(filter_expr)
  var_label <- attr(design$variables[[var]], "label")
  if (is.null(var_label)) var_label <- "No Label Specified"
  tryCatch(
    {
    design %>%
      { if (rlang::quo_is_null(f)) . else filter(., !!f) } %>% 
      drop_na(!!sym(var)) %>% 
      group_by(!!sym(var)) %>% 
      summarise(
        Prop            = survey_prop(x = !!sym(var), na.rm = TRUE, prop_method = "xlogit", vartype= c("se", "ci", "cv")) *100,
        TotalRespond    = sum(!is.na(!!sym(var))),
        TotalNA         = sum(is.na(!!sym(var)))
      ) %>% 
      ungroup() %>% 
      rename(
        Answer = !!sym(var),
      `Prop(SE)` = Prop_se,
      `Prop (Lower CI 95%)` = Prop_low,
      `Prop (Upper CI 95%)` = Prop_upp,
      `Prop(CV)` = Prop_cv
        ) %>%
      mutate(
        Variable = var,
        `Variable Label` = var_label,
        Answer = as.character(Answer),
        Answer = recode(
          Answer,
          `0` = "No",
          `1` = "Yes",
          .default = Answer
          )
        ) %>% 
      select(Variable,`Variable Label`, everything())
  },
    error = function(e) {
      warning("Error summarising ", var, ": ", e$message)
      tibble(
        Variable           = var,
        `Variable Label`   = var_label,
        Answer             = NA_character_,
        Prop               = NA_real_,
        `Prop(SE)`         = NA_real_,
        `Prop (Lower CI 95%)`= NA_real_,
        `Prop (Upper CI 95%)`= NA_real_,
        `Prop(CV)`         = NA_real_,
        TotalRespond       = NA_integer_,
        TotalNA            = NA_integer_
      )
    }
  )
}

calculateCrossTab <- function(var, group, design, filter_expr = NULL){
  f <- rlang::enquo(filter_expr)

  df <- design %>% 
    drop_na(!!sym(var), !!sym(group)) %>% 
    { if (rlang::quo_is_null(f)) . else filter(., !!f) }
  var_label <- attr(design$variables[[var]], "label")
  group_label <- attr(design$variables[[group]], "label")
  if (is.null(var_label)) var_label <- "No Label Specified"
  if (is.null(group_label)) group_label <- "No Label Specified"
  
  n_levels_var <- n_distinct(df$variables[[var]])
  n_levels_grp <- n_distinct(df$variables[[group]])
  if (nrow(df) == 0 || n_levels_var < 2 || n_levels_grp < 2) {
    return(tibble::tibble(
      Variable = var,
      `Variable Label` = var_label,
      `Grouping Variable` = group,
      `Group Label` = group_label,
      `Group Levels` = NA,
      `Variable Levels` = NA,
      Count = NA_real_,
      `Count(SE)` = NA_real_,
      `Count (Lower CI 95%)` = NA_real_,
      `Count (Upper CI 95%)` = NA_real_,
      `Count(CV)` = NA_real_
    ))
  }
  df %>% 
    survey_count(!!sym(group), !!sym(var), name = 'Count', vartype = c("se", "ci", "cv")) %>%
    mutate(
      Variable = var,
      `Grouping Variable` = group,
      `Variable Label` = var_label,
      `Group Label` = group_label
      ) %>% 
    rename(
      `Variable Levels` = !!sym(var),      
      `Group Levels` = !!sym(group),
    `Count(SE)` = Count_se,
    `Count (Lower CI 95%)` = Count_low,
    `Count (Upper CI 95%)` = Count_upp,
    `Count(CV)` = Count_cv
    ) %>% 
    mutate(
      `Variable Levels` = recode(as.character(`Variable Levels`), `0` = "No", `1` = "Yes"),
      `Group Levels` = recode(as.character(`Group Levels`), `0` = "No", `1` = "Yes")
    ) %>% 
    select(Variable,`Variable Label`,`Grouping Variable`, `Group Label`, `Group Levels`, `Variable Levels`, everything())
}

calculatePropGrouped <- function(var, group, design, filter_expr = NULL) {
  f <- rlang::enquo(filter_expr)
  var_label <- attr(design$variables[[var]], "label")
  group_label <- attr(design$variables[[group]], "label")
  if (is.null(var_label)) var_label <- "No Label Specified"
  if (is.null(group_label)) group_label <- "No Label Specified"
  tryCatch(
    {
    design %>%
      { if (rlang::quo_is_null(f)) . else filter(., !!f) } %>% 
      drop_na(!!sym(var), !!sym(group)) %>% 
      group_by(!!sym(group),!!sym(var) ) %>% 
      summarise(
        Prop = survey_prop(x = !!sym(var), na.rm = TRUE, prop_method = "xlogit", vartype= c("se", "ci", "cv")) *100
        ) %>% 
      ungroup() %>% 
        mutate(
          Variable = var,
          `Grouping Variable` = group,
          `Variable Label` = var_label,
          `Group Label` = group_label
          ) %>% 
      rename(
      `Variable Levels` = !!sym(var),      
      `Group Levels` = !!sym(group),
      `Prop(SE)` = Prop_se,
      `Prop (Lower CI 95%)` = Prop_low,
      `Prop (Upper CI 95%)` = Prop_upp,
      `Prop(CV)` = Prop_cv
        ) %>%
      mutate(
        `Variable Levels` = recode(as.character(`Variable Levels`), `0` = "No", `1` = "Yes"),
        `Group Levels` = recode(as.character(`Group Levels`), `0` = "No", `1` = "Yes")
      ) %>% 
      select(Variable,`Variable Label`,`Grouping Variable`, `Group Label`, `Group Levels`, `Variable Levels`, everything())
  },
    error = function(e) {
      warning("Error summarising ", var, ": ", e$message)
      tibble(
        Variable           = var,
        `Variable Label`   = var_label,
        `Grouping Variable` =group,
        `Group Label` = group_label,
        `Group Levels`= NA_character_,
        `Variable Levels` = NA_character_,
        Prop               = NA_real_,
        `Prop(SE)`         = NA_real_,
        `Prop (Lower CI 95%)`= NA_real_,
        `Prop (Upper CI 95%)`= NA_real_,
        `Prop(CV)`         = NA_real_
      )
    }
  )
}

```

## a) Subset of Respondents Ages 13 to 17 who reported transactional sex (CSEC)

```{r CSECDescripAge13to17, asis = TRUE}

CSECAgeDescriptives <- c("SexTransactAge", "SexTransactInitAge") %>% 
  map( ~ calculateMean_Total(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age13to17 == 1
    )
  ) %>% 
  list_rbind()

createKable(CSECAgeDescriptives, "Mean & Totals for Transactional Sex Victim and Perpetrator Ages filtered by respondents Ages 13-17")
    

CSECCount <- c("SexTransact", "SexTransactType", "SexTransactTourist") %>% 
    map( ~ calculateCount(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age13to17 == 1
    )
  ) %>% 
  list_rbind()
  
createKable(CSECCount, "Counts for Transactional Sex, Type of Transactional Sex, and Transactional Sex with a Tourist filtered by respondents Ages 13-17")


CSECProp <- c("SexTransact", "SexTransactType", "SexTransactTourist") %>% 
    map( ~ calculateProp(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age13to17 == 1
    )
  ) %>% 
  list_rbind    
createKable(CSECProp, "Proportions for Transactional Sex, Type of Transactional Sex, and Transactional Sex with a Tourist filtered by respondents Ages 13-17")

```
## b) Subset of Respondents Ages 18 Plus who reported transactional sex while a minor (CSEC)
```{r CSECDescripAge18PlusCSEC, asis = TRUE}

CSECAgeDescriptives <- c("SexTransactAge", "SexTransactInitAge") %>% 
  map( ~ calculateMean_Total(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age18Plus == 1 & CSEC == 1
    )
  ) %>% 
  list_rbind()

createKable(CSECAgeDescriptives, "Mean & Totals for Transactional Sex Victim and Perpetrator Ages filtered by respondents Ages 18 Plus who reported CSEC")
    
CSECCount <- c("SexTransact", "SexTransactType", "SexTransactTourist") %>% 
    map( ~ calculateCount(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age18Plus == 1 & CSEC == 1
    )
  ) %>% 
  list_rbind()
  
createKable(CSECCount, "Counts for Transactional Sex, Type of Transactional Sex, and Transactional Sex with a Tourist filtered by respondents Ages 18 Plus who reported CSEC")

CSECProp <- c("SexTransact", "SexTransactType", "SexTransactTourist") %>% 
    map( ~ calculateProp(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age18Plus == 1 & CSEC == 1
    )
  ) %>% 
  list_rbind    
createKable(CSECProp, "Proportions for Transactional Sex, Type of Transactional Sex, and Transactional Sex with a Tourist filtered by respondents Ages 18 Plus who reported CSEC")

```

# **6. Main Analysis**
Performs the main analyses on CSEC among respondents and associations with demographic, psychosocial, and enviornmental factors. Analysis is filtered by age. 

## a) Descriptives, Proportions, and Counts 
Proportions were all multiplied by 100 and represent the estimated percentages of the target population.

### i) Filtered: Ages 13 to 17 who answered question about transactional sex (CSEC)
```{r DescriptivesAge13to17, asis = TRUE}

ContVariables <- c("Age","MoneyWorryCont", "FriendCont", "MomCloseCont","DadCloseCont", "AllInsecure",
                   "ParMonitContFriends", "ParMonitContMoney", "ParMonitContAftSchool", "ParMonitContNight",
                   "ParMonitContFreeTime","AllMonit","AllIPVPhys","AllNonParentPhys","AllParentEmotAbuse",
                   "AllParentPhys","AllIPVEmot","AllMHsxs","WitnessAnyVio","AllPhysViolence","SexAbuseBroad",
                   "SexAbuseNarrow","IPVTotal","SexInitAge","SexPartners")

CatVariables <- c("Sex","Ethnicity","School","SharedHouse","InternetHome","GovSupport","NGOSupport",
               "VictimReg","ParentAbs","ChildOutHome","ChildStreet","VictimRegType","MoneyWorry",
               "FoodSecure","Employed","MomAlive","DadAlive","Partner","SafetyVio","SafetyWar","BullyVic",
               "MomAway","DadAway","Friend","MomClose","DadClose","BasicSecure","HousingSecure",
               "ExtraMoneySecure","ParMonitFriends","ParMonitMoney","ParMonitAftSchool","ParMonitNight",
               "ParMonitFreeTime","SexOrient","WitnessParIPV","WitnessSibAbuse","WitnessComVio",
               "WitnessArmConflict","SexAct","FirstSexWanted","SexAbuse","PartAttemptRape",
               "ElseAttemptRape","PartCompleteRape","ElseCompleteRape","Drugs","SelfHarm","SuicideIdea",
               "SuicideAttempt","STI","Alcohol","PhysCorp")

ContDescriptives <- ContVariables %>% 
  map( ~ calculateMean_Total(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age13to17 == 1 & !is.na(SexTransact)
    )
  ) %>% 
  list_rbind()

createKable(ContDescriptives, "Mean & Totals for Continous Variables filtered by respondents Ages 13 to 17")

CatDescriptives <- CatVariables %>% 
  map( ~ calculateProp(
    var = .x,
    design = vacsDesign,
    filter_expr = Age13to17 == 1 & !is.na(SexTransact)
    )
  ) %>% 
  list_rbind()

createKable(CatDescriptives, "Proportions for Categorical and Binarized Variables filtered by respondents Ages 13 to 17")
```

### ii) Filtered: Ages 18 Plus who reported transactional sex while a minor (CSEC)
```{r DescriptivesAge18PlusCSEC, asis=TRUE}

ContDescriptives <- ContVariables %>% 
  map( ~ calculateMean_Total(
    var = .x, 
    design = vacsDesign,
    filter_expr = Age18Plus == 1 & CSEC == 1
    )
  ) %>% 
  list_rbind()

createKable(ContDescriptives, "Mean & Totals for vontinuous variables filtered by respondents Ages 18 Plus who reported CSEC")

CatDescriptives <- CatVariables %>% 
  map( ~ calculateProp(
    var = .x,
    design = vacsDesign,
    filter_expr = Age18Plus == 1 & CSEC == 1
    )
  ) %>% 
  list_rbind()

createKable(CatDescriptives, "Proportions for Categorical and Binarized Variables filtered by respondents Ages 18 Plus who reported CSEC")
```

## b) Cross-Tabulations & Proportions by CSEC

### i) Filtered: Ages 13 to 17 who answered question about transactional sex (CSEC)

```{r crossTab1, asis = TRUE}
        
crossTabAge13to17 <- CatVariables %>% 
  map( ~ calculateCrossTab(
    var = .x, 
    group = "CSEC",
    design = vacsDesign,
    filter_expr = Age13to17 == 1
    )
  ) %>% 
  list_rbind()

createKable(crossTabAge13to17, "Cross-Tabulation of Variables by CSEC for Respondents Ages 13 to 17")

PropAge13to17 <- CatVariables %>% 
  map( ~ calculatePropGrouped(
    var = .x, 
    group = "CSEC",
    design = vacsDesign,
    filter_expr = Age13to17 == 1
    )
  ) %>% 
  list_rbind()
createKable(PropAge13to17, "Proportions of Variables by CSEC for Respondenets Ages 13 to 17")

```
### ii) Filtered: Ages 18 Plus who answered question about transactional sex while underage (CSEC)
```{r crossTab2, asis = TRUE}
        
crossTabAge18Plus <- CatVariables %>% 
  map( ~ calculateCrossTab(
    var = .x, 
    group = "CSEC",
    design = vacsDesign,
    filter_expr = Age18Plus == 1
    )
  ) %>% 
  list_rbind()

createKable(crossTabAge18Plus, "Cross-Tabulation of Variables by CSEC for Respondents Ages 18 Plus")

PropAge18Plus <- CatVariables %>% 
  map( ~ calculatePropGrouped(
    var = .x, 
    group = "CSEC",
    design = vacsDesign,
    filter_expr = Age18Plus == 1
    )
  ) %>% 
  list_rbind()
createKable(PropAge18Plus, "Proportions of Variables by CSEC for Respondenets Ages 18 Plus")

```

## c) Chi-Square Tests for Categorical Variables by CSEC

Calculated design-adjusted Wald Chi-Square Tests of Indepndence. 

### i) Filtered: Ages 13 to 17 who answered question about transactional sex (CSEC)
```{r chiSqu1, results='asis'}

calculateChiSquTest <- function(var, group, design, filter_expr = NULL, statistic = "adjWald", na.rm = TRUE) {
    filt_q <- rlang::enquo(filter_expr)
    var_q <- rlang::enquo(var)
    group_q <- rlang::enquo(group)
    
    fml <- reformulate(c(rlang::quo_name(var_q), rlang::quo_name(group_q)))
    
    result_design <- design %>% 
        { if (rlang::quo_is_null(filt_q)) . else filter(., !!filt_q) }
    
    tryCatch({
        svychisq(
            formula = fml,
            design = result_design,
            statistic = statistic,
            na.rm = na.rm
        )
    }, error = function(e) {
        warning(paste("Chi-square test failed:", e$message))
        return(NULL)
    })
}
chisq_table1 <- function(var, group, design, filter_expr = NULL, digits = 4) {
    var_name <- rlang::quo_name(rlang::enquo(var))
    group_name <- rlang::quo_name(rlang::enquo(group))
    

    chisq_result <- calculateChiSquTest(!!rlang::enquo(var), !!rlang::enquo(group), 
                                       design, !!rlang::enquo(filter_expr))
    
    if (is.null(chisq_result)) {
        cat("Chi-square test failed for: ", var_name, "\n")
        return(invisible(NULL))
    }
    

    cat("<b>Chi-Square Test Results:", var_name, "by", group_name, "</b>\n\n")
    
    pval <- chisq_result$p.value
    stars <- case_when(
            pval < 0.001 ~ "***",
            pval < 0.01  ~ "**",
            pval < 0.05  ~ "*",
            TRUE         ~ ""
            )
    
    pval_formatted <- if (stars != "") {
      paste0(stars, format.pval(pval, digits = 3, eps = 1e-3))
      } else {
        format.pval(pval, digits = 3, eps = 1e-3)
              }

    stats_table <- data.frame(
        F = round(chisq_result$statistic, digits),
        ndf = chisq_result$parameter[[1]],
        df = chisq_result$parameter[[2]], 
        `P Value` = pval_formatted,
        Method = chisq_result$method,
        check.names = FALSE
    )
    

    table_output <- knitr::kable(stats_table, format = "html") %>%
        kableExtra::kable_styling(bootstrap_options = c("striped", "condensed"))
    
    print(table_output)
    cat("\n\n<p><em>* p < .05, ** p < .01, *** p < .001</em></p>")
}

chisq_table2 <- function(var, group, design, filter_expr = NULL, digits = 4) {
    var_name <- rlang::quo_name(rlang::enquo(var))
    group_name <- rlang::quo_name(rlang::enquo(group))
    

    chisq_result <- calculateChiSquTest(!!rlang::enquo(var), !!rlang::enquo(group), 
                                       design, !!rlang::enquo(filter_expr))
    
    if (is.null(chisq_result)) {
        cat("Chi-square test failed for: ", var_name, "\n")
        return(invisible(NULL))
    }
    

    obs <- chisq_result$observed
    exp <- chisq_result$expected
    res <- chisq_result$residuals
    std <- chisq_result$stdres

    
    ethnicity <- rownames(obs)
    table_data <- data.frame(Ethnicity = ethnicity)
    

    group_levels <- colnames(obs)
    

    for (component in c("Obs.", "Exp.", "Res.", "StdRes.")) {
        for (group_level in group_levels) {
            col_name <- paste(group_name, "=", group_level, component)
            
            if (component == "Obs.") {
                table_data[[col_name]] <- round(obs[, group_level], digits)
            } else if (component == "Exp.") {
                table_data[[col_name]] <- round(exp[, group_level], digits)
            } else if (component == "Res.") {
                table_data[[col_name]] <- round(res[, group_level], digits)
            } else if (component == "StdRes.") {
                table_data[[col_name]] <- round(std[, group_level], digits)
            }
        }
    }
    

    table_output <- knitr::kable(table_data, format = "html") %>%
        kableExtra::kable_styling(bootstrap_options = c("striped", "condensed"))
    print(table_output)
    
}

for (v in CatVariables) {
    cat("\n\n---\n\n") 
    
    chisq_table1(!!sym(v), CSEC, vacsDesign, Age13to17 == 1)
    cat("\n\n")  
    chisq_table2(!!sym(v), CSEC, vacsDesign, Age13to17 == 1)
    cat("\n\n")
}

```
### ii) Filtered: Ages 18 Plus who answered question about transactional sex while underage (CSEC)
```{r chiSqu2, results='asis'}

for (v in CatVariables) {
    cat("\n\n---\n\n")  
    
    chisq_table1(!!sym(v), CSEC, vacsDesign, Age18Plus == 1)
    cat("\n\n")  
    chisq_table2(!!sym(v), CSEC, vacsDesign, Age18Plus == 1)
    cat("\n\n")
}

```


## d) T-Tests for Continous Variables Grouped by CSEC
Calculated design-adjusted two-sample t-tests. 

### i) Filtered: Ages 13 to 17 who answered question about transactional sex (CSEC)
```{r tTest1, results = 'asis'}
calculateTTest <- function(var, group, design, filter_expr = NULL, na.rm = TRUE) {
  filt_q <- rlang::enquo(filter_expr)
  var_q <- rlang::enquo(var)
  group_q <- rlang::enquo(group)
  fml <- reformulate(rlang::quo_name(group_q), response = rlang::quo_name(var_q))
  filtered_des <- design %>% 
    { if (rlang::quo_is_null(filt_q)) . else filter(., !!filt_q) }
  
  test <- svyttest(
      formula = fml,
      design = filtered_des,
      na.rm = na.rm
    )
  ci <- confint(test, level=0.95)
  list(
    test = test,
    confint = ci
  )
  
}

ttest_resultsA <- ContVariables %>% 
  set_names() %>% 
  map(~{
    result <- calculateTTest(
      var = !!rlang::sym(.x),
      group = CSEC,
      design = vacsDesign,
      filter_expr = Age13to17 == 1
    )
    
    pval <- result$test$p.value
    stars <- case_when(
      pval < 0.001 ~ "***",
      pval < 0.01  ~ "**",
      pval < 0.05  ~ "*",
      TRUE         ~ ""
    )
    
    pval_formatted <- if (stars != "") {
      paste0(stars, format.pval(pval, digits = 3, eps = 1e-3))
      } else {
        format.pval(pval, digits = 3, eps = 1e-3)
        }
    
    tibble(
      Variable = .x,
      `Mean Diff.` = round(result$test$estimate, 3),
      `t-Statistic` = round(result$test$statistic, 3),
      df = round(result$test$parameter, 1),
      `p-value` = pval_formatted,
      `95% CI Lower` = round(result$confint[1], 3),
      `95% CI Upper` = round(result$confint[2], 3),
      Method = paste0(result$test$method),
      Direction = paste0(result$test$alternative)
    )
  }) %>% 
  bind_rows()

knitr::kable(ttest_resultsA, caption = "T-test Results for Age 13–17", format = "html") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "condensed"))

cat("\n\n<p><em>* p < .05, ** p < .01, *** p < .001</em></p>")

```
### ii) Filtered: Ages 18 Plus who answered question about transactional sex while underage (CSEC)
```{r tTest2, results='asis'}

ttest_resultsB <- ContVariables %>% 
  set_names() %>% 
  map(~{
    result <- calculateTTest(
      var = !!rlang::sym(.x),
      group = CSEC,
      design = vacsDesign,
      filter_expr = Age18Plus == 1
    )
    
    pval <- result$test$p.value
    stars <- case_when(
      pval < 0.001 ~ "***",
      pval < 0.01  ~ "**",
      pval < 0.05  ~ "*",
      TRUE         ~ ""
    )
    
    pval_formatted <- if (stars != "") {
      paste0(stars, format.pval(pval, digits = 3, eps = 1e-3))
      } else {
        format.pval(pval, digits = 3, eps = 1e-3)
        }
    
    tibble(
      Variable = .x,
      `Mean Diff.` = round(result$test$estimate, 3),
      `t-Statistic` = round(result$test$statistic, 3),
      df = round(result$test$parameter, 1),
      `p-value` = pval_formatted,
      `95% CI Lower` = round(result$confint[1], 3),
      `95% CI Upper` = round(result$confint[2], 3),
      Method = paste0(result$test$method),
      Direction = paste0(result$test$alternative)
    )
  }) %>% 
  bind_rows()


knitr::kable(ttest_resultsB, caption = "T-test Results for Age 18+", format = "html") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "condensed"))

cat("\n\n<p><em>* p < .05, ** p < .01, *** p < .001</em></p>")
```

# **References & Resources**
- Lumley, T. (2010). Complex Surveys: A Guide to Analysis Using R. Wiley.
- Bruin, J. (2006). Survey Data Analysis With R.  UCLA: Statistical Consulting Group.  https://stats.oarc.ucla.edu/r/seminars/survey-data-analysis-with-r/
- Lumley, T., Gao, P., & Schneider, B. (2019). survey: Analysis of Complex Survey Samples (R Package Manual). CRAN. https://cran.r-project.org/web/packages/survey/survey.pdf
- Freedman, G., Lumley, T., Zoltak, T., Schneider, B., & Krivitsky, P.(2024). srvyr: 'dplyr'-like syntax for survey analysis (R Package Manual). CRAN. https://cran.r-project.org/web/packages/srvyr/srvyr.pdf
- Lohr, S. L. (2010). Sampling: Design and Analysis (2nd ed.). Boston, MA: Brooks/Cole.


